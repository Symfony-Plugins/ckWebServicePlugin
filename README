= ckWebService plugin =

The `ckWebServicePlugin` is a symfony plugin that let you expose your modules and actions as a webservice.

The Plugin is based on the standard PHP SOAP module, see http://de.php.net/manual/en/ref.soap.php.

It offers automatic generation of .wsdl files from your source code, using the WSDL Generator from http://www.djkaty.com/drupal/php-wsdl.

== Installation ==

  * Install the plugin

    execute:    

    {{{
      symfony plugin-install http://plugins.symfony-project.com/ckWebServicePlugin
    }}}

    or:

    download the attached archive and put the `ckWebServicePlugin` into your `/plugins` folder

  * Configure the application in your `app.yml`

    {{{
      # your soap enviroment
      soap:
        # enable the `ckSoapParameterFilter`
        enable_soap_parameter: on
        ck_web_service_plugin:
          # the location of your .wsdl file
          wsdl: http://localhost/myWebService.wsdl
          # the class that will be registered as handler for webservice requests
          handler: ckSoapHandler
          # set the persistence mode
          persist: %SOAP_PERSISTENCE_SESSION%
          # set the method every action has to implement to get the result of the action
          result_callback: getSoapResult
          # the options array, which is passed to the `SoapServer` constructor
          options:
            encoding: utf-8
            soap_version: %SOAP_1_2%
    }}}

    You only have to configure `wsdl`, `options` and set `enable_soap_parameter` to `on`, if you want to use the standard settings shown above.

  * Enable the controller in your `factories.yml`

    {{{
      # your soap enviroment
      soap:
        controller:
          class: ckWebServiceController
    }}}

  * Enable the `ckSoapParameterFilter` in your `filters.yml`

    {{{
      soap_parameter:
        class: ckSoapParameterFilter
        param:
          # `app_enable_soap_parameter` has to be set to `on` so the filter is only enabled in soap mode
          condition: %APP_ENABLE_SOAP_PARAMETER%
    }}}

  * Clear your cache

    {{{
      symfony cc
    }}}

== Enabling actions for automatic wsdl generation ==

  * Add `@ws-enable`-tag to the comment block

  * Also the method has no parameters add `@param`-tags for each parameter you want to use

  * Add a `@return`-tag for the return type of the method

  * The following example action should illustrate the use

    {{{      
      class fooActions extends sfActions
      {
        /**
         * Method to get the result, when in soap mode
         */
        public function getSoapResult()
        {
          return $this->result;
        }

        /**
         * Executes index action
         *
         * @ws-enable
         * @param string $test A string parameter
         *
         * @return string      A string
         */
        public function executeIndex()
        {
            $this->result = 'Parameter $test='.$this->request->getParameter('test');

            //return what you want, the view rendering will be bypassed any way
            return sfView::SUCCESS;
        }

        /**
         * A method which will not be exposed in the wsdl.
         *
         * @param string $test A string parameter
         *
         * @return string      A string
         */
        public function executeBar()
        {

        }
      }
    }}}

    The resulting webservice method, when using the pake task, will be `foo_Index` with parameter `test` of type `string` and return type `string`.

== Generating the .wsdl file ==

  * Execute the pake task, be sure the env_name is the same you used in the configuration

    {{{
      symfony build-wsdl app_name env_name [controller_name] [debug] webservice_name webservice_base_url
    }}}

  * Clear your cache

    {{{
      symfony cc
    }}}

  * This will add a .wsdl file to your `/web` folder, and add configuration on how to map the soap to request parameters to each `module.yml`, which exposes at least one method

  * The names of the methods in the generated .wsdl file will follow the scheme: `module_Action`

  * This task will also create a new controller in your `/web` folder

  * Example:

    {{{
      symfony build-wsdl fronted soap myFooBarService http://www.myfoobar.com/
    }}}

    * This will add a `frontend_soap.php` and a `myFooBarService.wsdl` to your `/web` folder

    * The endpoint for the generated service will be `http://www.myfoobar.com/frontend_soap.php`

== Notes ==

  * The whole view rendering part is bypassed any way, it doesn't matter if your module action returns sfView::NONE or sfView::SUCCESS, this has the advantage you can use the action easily in soap mode and normal mode (viewing via browser) without having to add additional conditions

  * Complex Types are also supported by the `wsdl-build`-task, but the classes have to be in the `/lib` or `/apps/my_app/lib` folder

  * You can use the symfony session features as usual

  * When you are developing you might add the following line to your `php.yml` to disable caching of the .wsdl file
  
    {{{
      set:
        soap.wsdl_cache_enabled: off
    }}}

  * To use your own .wsdl or to use more descriptive method names, you should implement your own handler class and set the handler config parameter in your `app.yml`, see the following example:

    {{{
      class mySoapHandler
      {
        public function descriptiveFoo($foo, $bar)
        {
          return sfContext::getInstance()->getController()->invokeSoapEnabledAction('fooModule', 'index', array($foo, $bar));
        }
      }
    }}}

    If you have edited the `modules.yml` of your `fooModule` the mapping to request parameters will still be available, otherwise you will find them in the array returned by:

    {{{
      $request->getParameter('param', 'ckWebServicePlugin');
    }}}

  * Browse the source to better understand what's going on inside :)

== TODO ==

  - decide how to handle redirects
  - add a mixin method to actions, so you don't have to implement the getSoapResult in every *Actions class
  - add the posibility to choose wether rendering is bypassed or not (per app / per module / per action)
  - switch to symfony 1.1 (change the `build-wsdl` task, ...)
  - write tests
  - rewrite the wsdl generator
  - enable nusoap, PEAR::SOAP as soap_server

  - if anyone likes to contribute just let me know, help is welcome

== Contact ==

  You may write me an email to: christian-kerl [at] web [dot] de
